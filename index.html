<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script type="text/javascript" src="camera.js"></script>
        <script type="text/javascript" src="entity.js"></script>
        <script type="text/javascript" src="vector.js"></script>
        <script type="text/javascript" src="map.js"></script>
        <script type="text/javascript" src="tile.js"></script>
        <script type="text/javascript" src="player.js"></script>
        <script type="text/javascript" src="movingtile.js"></script>
        <script type="text/javascript" src="rotatingtile.js"></script>
        <script type="text/javascript" src="ladder.js"></script>
        <script type="text/javascript" src="topladder.js"></script>
        <script type="text/javascript" src="celilingtile.js"></script>
        <script type="text/javascript">
            var canvas;
            var context;
            var map;
            var player;
            var prevTime = 0;
            var offsetY;
            var camera;
            var movingTile;
            
            window.onload = function() {
              console.log("loaded");
              
              camera = new Camera();
              var tileWidth = 50;
              var tileHeight = 50;
              var mapWidth = 8;
              var mapHeight = 7;
              var matrix = [
                  1,1,1,1,1,1,1,1,
                  1,0,0,0,0,0,0,1,
                  1,0,0,0,1,3,1,1,
                  1,0,0,0,0,2,0,1,
                  1,0,0,0,4,2,0,1,
                  1,0,0,4,4,2,0,1,
                  1,1,1,1,1,1,1,1,
              ];
              
              
              
              var canvasWidth = tileWidth * 5;
              var canvasHeight = tileHeight * 4;
              map = new Map(matrix, mapWidth, mapHeight, tileWidth, tileHeight, canvasWidth, canvasHeight, camera);
              player = new Player(tileWidth * 0.5, tileHeight * 0.5, 1, 1, map);
              movingTile = new RotatingTile(camera, map, 2, 2);
              player.movingTiles.push(movingTile);
              canvas = document.getElementById("engine");
              canvas.width = canvasWidth;
              canvas.height = canvasHeight;
              context = canvas.getContext("2d");
              offsetY = canvasHeight; 
              canvas.style = "border: 1px solid #ccc";
              document.onkeydown = onKeyDown;
              document.onkeyup = onKeyUp;
              requestAnimationFrame(update);
              
            };
            
            var fpsLimit = 0;
            function update(time) {
                var dt = (time - prevTime) / 1000;
                
                
                var maxFps = 1 / 10;
                fpsLimit += dt;
                if (fpsLimit >= maxFps) {
                    dt = fpsLimit;
                    fpsLimit = 0;
                } else {
                    prevTime = time;
                    requestAnimationFrame(update);
                    return;
                }
                
                //console.log(1 / dt);
                context.clearRect(0, 0, canvas.width, canvas.height);
                
                camera.update(player);
                
                movingTile.update(dt);
            
                player.update(dt);
                
                map.render(context);
                player.render(context);
                movingTile.render(context);
                
                prevTime = time;
                requestAnimationFrame(update);
            }
            
            function onKeyDown(key) {
                if (key.keyCode === 38) {
                    player.moveUp(true);
                }
                if (key.keyCode === 37) {
                    player.moveLeft(true);
                }
                if (key.keyCode === 39) {
                    player.moveRight(true);
                }
                if (key.keyCode === 40) {
                    player.moveDown(true);
                }
                if (key.keyCode === 32) {
                    player.makeJump(true);
                }
            }
            
            function onKeyUp(key) {
                if (key.keyCode === 38) {
                    player.moveUp(false);
                }
                if (key.keyCode === 37) {
                    player.moveLeft(false);
                }
                if (key.keyCode === 39) {
                    player.moveRight(false);
                }
                if (key.keyCode === 40) {
                    player.moveDown(false);
                }
                if (key.keyCode === 32) {
                    player.makeJump(false);
                }
            }
        </script>
    </head>
    <body>
        <canvas id="engine"></canvas>
    </body>
</html>
