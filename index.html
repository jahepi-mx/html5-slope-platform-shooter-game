<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script type="text/javascript" src="camera.js"></script>
        <script type="text/javascript" src="entity.js"></script>
        <script type="text/javascript" src="vector.js"></script>
        <script type="text/javascript" src="map.js"></script>
        <script type="text/javascript" src="tile.js"></script>
        <script type="text/javascript" src="player.js"></script>
        <script type="text/javascript" src="movingtile.js"></script>
        <script type="text/javascript" src="rotatingtile.js"></script>
        <script type="text/javascript" src="ladder.js"></script>
        <script type="text/javascript" src="topladder.js"></script>
        <script type="text/javascript" src="celilingtile.js"></script>
        <script type="text/javascript" src="slopetile.js"></script>
        <script type="text/javascript" src="parallaxbg.js"></script>
        <script type="text/javascript" src="bullet.js"></script>
        <script type="text/javascript" src="particle.js"></script>
        <script type="text/javascript" src="assets.js"></script>
        <script type="text/javascript" src="atlas.js"></script>
        <script type="text/javascript" src="animation.js"></script>
        <script type="text/javascript" src="cursor.js"></script>
        <script type="text/javascript">
            var canvas;
            var context;
            var map;
            var player;
            var prevTime = 0;
            var offsetY;
            var camera;
            var cursor;
            var movingTile;
            var parallaxBg;
            var parallaxBg2;
            var parallaxBg3;
            
            window.onload = function() {
              var assets = Assets.getInstance();
              assets.loadAll(onLoadAssets, null);
            };
            
            function onLoadAssets() {
                var atlas = Atlas.getInstance();
                atlas.loadAll(onLoadAtlas, null);
            }
            
            function onLoadAtlas() {
                camera = new Camera();
                var tileWidth = 150; //150 * 1.5;
                var tileHeight = 150; //150;
                var mapWidth = 21;
                var mapHeight = 7;
                var matrix = [
                    1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
                    1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
                    1,0,0,0,0,0,1,3,1,0,0,0,0,0,0,0,0,0,0,0,1,
                    1,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,1,
                    1,0,0,0,0,5,5,5,1,5,5,0,0,0,0,0,5,5,0,0,1,
                    1,0,0,5,5,5,1,1,1,1,5,5,5,0,0,0,1,1,0,0,1,
                    1,1,5,5,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
                ];



                var canvasWidth = tileWidth * 5;
                var canvasHeight = tileHeight * 4;
                parallaxBg = new ParallaxBg(camera, canvasWidth, canvasHeight, "background", 1.5);
                parallaxBg2 = new ParallaxBg(camera, canvasWidth, canvasHeight, "background2", 1.1);
                parallaxBg3 = new ParallaxBg(camera, canvasWidth, canvasHeight, "background3", 0.8);
                map = new Map(matrix, mapWidth, mapHeight, tileWidth, tileHeight, canvasWidth, canvasHeight, camera);
                player = new Player(tileWidth * 0.9, tileHeight * 0.9, 1, 1, map);
                movingTile = new RotatingTile(camera, map, 2, 2);
                player.movingTiles.push(movingTile);
                canvas = document.getElementById("engine");
                canvas.width = canvasWidth;
                canvas.height = canvasHeight;
                context = canvas.getContext("2d");
                offsetY = canvasHeight; 
                canvas.style = "border: 1px solid #ccc";
                document.onkeydown = onKeyDown;
                document.onkeyup = onKeyUp;
                cursor = Cursor.getInstance();
                canvas.addEventListener("mousemove", function(evt) {
                    var rect = canvas.getBoundingClientRect();
                    var x = evt.clientX - rect.left;
                    var y = evt.clientY - rect.top;
                    cursor.update(x, y);
                });
                
                canvas.addEventListener("mousedown", function(evt) {
                    cursor.isPressed = true;
                });

                canvas.addEventListener("mouseup", function(evt) {
                    cursor.isPressed = false;
                });
                
                canvas.addEventListener("mouseout", function(evt) {
                    cursor.isPressed = false;
                });
                
                requestAnimationFrame(update);
            }
            
            var fpsLimit = 0;
            function update(time) {
                var dt = (time - prevTime) / 1000;                               
                /*
                var maxFps = 1 / 10;
                fpsLimit += dt;
                if (fpsLimit >= maxFps) {
                    dt = fpsLimit;
                    fpsLimit = 0;
                } else {
                    prevTime = time;
                    requestAnimationFrame(update);
                    return;
                }
                */
                //console.log(1 / dt);
                context.clearRect(0, 0, canvas.width, canvas.height);
                context.imageSmoothingEnabled = false;
                
                map.update(dt);
                camera.update(player);
                movingTile.update(dt);
                player.update(dt);
                
                parallaxBg3.render(context);
                parallaxBg.render(context);
                parallaxBg2.render(context); 
                
                map.render(context);
                movingTile.render(context);
                player.render(context);

                prevTime = time;
                requestAnimationFrame(update);
            }
            
            function onKeyDown(key) {
                if (key.keyCode === 38) {
                    player.moveUp(true);
                }
                if (key.keyCode === 37) {
                    player.moveLeft(true);
                }
                if (key.keyCode === 39) {
                    player.moveRight(true);
                }
                if (key.keyCode === 40) {
                    player.moveDown(true);
                }
                if (key.keyCode === 32) {
                    player.makeJump(true);
                }
            }
            
            function onKeyUp(key) {
                if (key.keyCode === 38) {
                    player.moveUp(false);
                }
                if (key.keyCode === 37) {
                    player.moveLeft(false);
                }
                if (key.keyCode === 39) {
                    player.moveRight(false);
                }
                if (key.keyCode === 40) {
                    player.moveDown(false);
                }
                if (key.keyCode === 32) {
                    player.makeJump(false);
                }
            }
        </script>
    </head>
    <body>
        <canvas id="engine"></canvas>
    </body>
</html>
