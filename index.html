<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script type="text/javascript" src="utils/camera.js"></script>
        <script type="text/javascript" src="entities/entity.js"></script>
        <script type="text/javascript" src="math/vector.js"></script>
        <script type="text/javascript" src="levels/map.js"></script>
        <script type="text/javascript" src="tiles/tile.js"></script>
        <script type="text/javascript" src="entities/player.js"></script>
        <script type="text/javascript" src="entities/monster.js"></script>
        <script type="text/javascript" src="tiles/movingtile.js"></script>
        <script type="text/javascript" src="tiles/rotatingtile.js"></script>
        <script type="text/javascript" src="tiles/ladder.js"></script>
        <script type="text/javascript" src="tiles/topladder.js"></script>
        <script type="text/javascript" src="tiles/celilingtile.js"></script>
        <script type="text/javascript" src="tiles/slopetile.js"></script>
        <script type="text/javascript" src="utils/parallaxbg.js"></script>
        <script type="text/javascript" src="entities/bullet.js"></script>
        <script type="text/javascript" src="entities/particle.js"></script>
        <script type="text/javascript" src="utils/assets.js"></script>
        <script type="text/javascript" src="utils/atlas.js"></script>
        <script type="text/javascript" src="utils/animation.js"></script>
        <script type="text/javascript" src="utils/cursor.js"></script>
        <script type="text/javascript" src="levels/level1.js"></script>
        <script type="text/javascript" src="utils/objectpooling.js"></script>
        <script type="text/javascript">
            var canvas;
            var context;
            var prevTime = 0;
            var offsetY;
            var cursor;
            var currentLevel = null;
            
            window.onload = function() {
                var assets = Assets.getInstance();
                assets.loadAll(onLoadAssets, null);
            };
            
            function onLoadAssets() {
                var atlas = Atlas.getInstance();
                atlas.loadAll(onLoadAtlas, null);
            }
            
            function onLoadAtlas() {
                var tileWidth = window.innerWidth / 5;
                var tileHeight = window.innerHeight / 4;
                var canvasWidth = tileWidth * 5;
                var canvasHeight = tileHeight * 4;
                canvas = document.getElementById("engine");
                context = canvas.getContext("2d");
                offsetY = canvasHeight; 
                canvas.style = "border: 1px solid #ccc; background-color: #ff7f15";
                document.onkeydown = onKeyDown;
                document.onkeyup = onKeyUp;
                cursor = Cursor.getInstance();
                canvas.addEventListener("mousemove", function(evt) {
                    var rect = canvas.getBoundingClientRect();
                    var x = evt.clientX - rect.left;
                    var y = evt.clientY - rect.top;
                    cursor.update(x, y);
                });
                
                canvas.addEventListener("mousedown", function(evt) {
                    cursor.isPressed = true;
                });

                canvas.addEventListener("mouseup", function(evt) {
                    cursor.isPressed = false;
                });
                
                canvas.addEventListener("mouseout", function(evt) {
                    cursor.isPressed = false;
                });
                
                var assets = Assets.getInstance();
                canvas.width = assets.spritesAtlas.width;
                canvas.height = assets.spritesAtlas.height;
                context.drawImage(assets.spritesAtlas, 0, 0);
                var pixelData = context.getImageData(0, 0, assets.spritesAtlas.width, assets.spritesAtlas.height).data;
                canvas.width = canvasWidth;
                canvas.height = canvasHeight;
                currentLevel = new Level1(pixelData, tileWidth, tileHeight, canvasWidth, canvasHeight);
                requestAnimationFrame(update);
            }
            
            var fpsLimit = 0;
            function update(time) {
                var dt = (time - prevTime) / 1000;                               
                var maxFps = 1 / 35;
                fpsLimit += dt;
                if (fpsLimit >= maxFps) {
                    dt = fpsLimit;
                    fpsLimit = 0;
                } else {
                    prevTime = time;
                    requestAnimationFrame(update);
                    return;
                }
                
                var fps = 1 / dt;
                if (fps < 10) {
                    prevTime = time;
                    requestAnimationFrame(update);
                    return;
                }
                
                context.clearRect(0, 0, canvas.width, canvas.height);
                context.imageSmoothingEnabled = false;
                
                currentLevel.update(dt);
                currentLevel.render(context);        
                
                context.fillStyle = "#00ff00";
                context.font = parseInt(currentLevel.map.tileHeight * 0.15) + "px Arial";
                context.fillText(parseInt(fps), currentLevel.map.tileWidth * 0.15, currentLevel.map.tileHeight * 0.15);
                
                prevTime = time;
                requestAnimationFrame(update);
            }
            
            function onKeyDown(key) {
                if (key.keyCode === 38) {
                    currentLevel.player.moveUp(true);
                }
                if (key.keyCode === 37) {
                    currentLevel.player.moveLeft(true);
                }
                if (key.keyCode === 39) {
                    currentLevel.player.moveRight(true);
                }
                if (key.keyCode === 40) {
                    currentLevel.player.moveDown(true);
                }
                if (key.keyCode === 32) {
                    currentLevel.player.makeJump(true);
                }
            }
            
            function onKeyUp(key) {
                if (key.keyCode === 38) {
                    currentLevel.player.moveUp(false);
                }
                if (key.keyCode === 37) {
                    currentLevel.player.moveLeft(false);
                }
                if (key.keyCode === 39) {
                    currentLevel.player.moveRight(false);
                }
                if (key.keyCode === 40) {
                    currentLevel.player.moveDown(false);
                }
                if (key.keyCode === 32) {
                    currentLevel.player.makeJump(false);
                }
            }
        </script>
    </head>
    <body style="margin:0; padding: 0">
        <canvas id="engine"></canvas>
    </body>
</html>
